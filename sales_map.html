<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Media Sales Map</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        
        /* --- MAP STYLES --- */
        .map-wrapper {
            background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow-x: auto; display: flex; justify-content: center; margin-top: 20px;
        }

        .store-grid {
            display: grid;
            grid-template-columns: 50px 30px 180px 30px 180px 30px 180px 30px 180px 20px;
            grid-template-rows: 
        30px  /* 1. WL Top */
        60px  /* 2. Gap (ลดจาก 30px -> 20px) */
        70px  /* 3. Row 1 */
        30px  /* 4. Gap */
        70px  /* 5. Row 2 */
        30px  /* 6. Gap */
        70px  /* 7. Row 3 */
        45px  /* 8. Gap Small */
        45px  /* 9. Bottom Wall */
        50px; /* 10. Outside Bottom */
            gap: 2px;
            position: relative;
            width: fit-content;
        }

        .store-bg { grid-column: 2 / -1; grid-row: 1 / 10; background-color: #cbd5e1; border-radius: 20px; z-index: 0; }
        .office-bg { grid-column: 9 / span 2; grid-row: 1 / span 5; background-color: #e2e8f0; border-top-right-radius: 20px; border-bottom-left-radius: 20px; opacity: 0.6; z-index: 0; }

        .slot-box {
            background-color: #64748b; border: 1px solid #475569; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; color: white; font-weight: bold;
            cursor: pointer; transition: all 0.2s; z-index: 10; overflow: hidden; text-align: center;
        }
        .slot-box:hover, .g-slot:hover { 
            background-color: #3b82f6 !important; 
            transform: scale(1.05); z-index: 50; 
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        
        .g-container { display: grid; grid-template-rows: 1fr 1fr; grid-template-columns: 1fr 1fr 1fr; gap: 2px; background-color: #e2e8f0; padding: 3px; border-radius: 4px; z-index: 10; }
        .g-slot { background-color: #94a3b8; border-radius: 2px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: white; cursor: pointer; transition: all 0.2s; overflow: hidden; white-space: nowrap; }

        .cashier-box { 
            background-color: #e2e8f0; border: 2px solid #94a3b8; border-radius: 8px; 
            color: #475569; font-weight: bold; display: flex; align-items: center; justify-content: center; 
            z-index: 10; font-size: 14px; cursor: default; 
        }

        .outside-box { background-color: #94a3b8; border-color: #64748b; }
        .vertical-text { writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); }
        .move-up { transform: translateY(-30px); }
        .entrance-label { writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); display: flex; align-items: center; justify-content: center; color: #94a3b8; font-weight: bold; font-size: 20px; letter-spacing: 4px; opacity: 0.6; pointer-events: none; }

        /* --- MODAL & CAROUSEL --- */
        #slotModal { transition: opacity 0.2s ease; }
        .carousel-btn {
            position: absolute; top: 50%; transform: translateY(-50%);
            background-color: rgba(0,0,0,0.5); color: white; width: 30px; height: 30px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 20;
        }
        .carousel-prev { left: 10px; }
        .carousel-next { right: 10px; }
        .carousel-dots { position: absolute; bottom: 10px; left: 0; right: 0; display: flex; justify-content: center; gap: 6px; z-index: 20; }
        .dot { width: 6px; height: 6px; border-radius: 50%; background: rgba(255,255,255,0.5); transition: 0.2s; }
        .dot.active { background: white; transform: scale(1.2); }
    </style>
</head>
<body>

    <header class="bg-white border-b border-gray-200 sticky top-0 z-40 shadow-sm">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center font-bold text-white text-xl">
                    <i class="fa-solid fa-map-location-dot"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-gray-800">SALES MAP</h1>
                    <p class="text-xs text-gray-500">คลิกที่จุดเพื่อดูสถานะการจอง (L1-L6)</p>
                </div>
            </div>
            <a href="admin.html" class="text-sm text-gray-500 hover:text-indigo-600 font-bold transition">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back to Admin
            </a>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        
        <div class="map-wrapper">
            <div class="store-grid">
                
                <div class="store-bg"></div>
                <div class="office-bg"></div>

                <div id="ML" class="slot-box outside-box col-start-1 row-start-1 row-span-2 w-full" onclick="openModal('ML')">ML</div>
                <div class="col-start-1 row-start-3 row-span-5 entrance-label w-full flex items-center justify-center">ENTRANCE</div>
                <div id="MR" class="slot-box outside-box col-start-1 row-start-8 row-span-2 w-full" onclick="openModal('MR')">MR</div>

                <div class="col-start-2 col-span-7 row-start-1 flex gap-1 h-8 mt-2 z-10 justify-start px-2">
                    <div id="WL1" class="slot-box flex-1" onclick="openModal('WL1')">WL1</div>
                    <div id="WL2" class="slot-box flex-1" onclick="openModal('WL2')">WL2</div>
                    <div id="WL3" class="slot-box flex-1" onclick="openModal('WL3')">WL3</div>
                    <div id="WL4" class="slot-box flex-1" onclick="openModal('WL4')">WL4</div>
                    <div id="WL5" class="slot-box flex-1" onclick="openModal('WL5')">WL5</div>
                    <div id="WL6" class="slot-box flex-1" onclick="openModal('WL6')">WL6</div>
                    <div id="WL7" class="slot-box flex-1" onclick="openModal('WL7')">WL7</div>
                    <div id="WL8" class="slot-box flex-1" onclick="openModal('WL8')">WL8</div>
                </div>

                <div class="col-start-3 row-start-3 g-container move-up">
                    <div id="GL1-F" class="g-slot" onclick="openModal('GL1-F')">GL1-F</div> <div id="GL1-M" class="g-slot" onclick="openModal('GL1-M')">GL1-M</div> <div id="GL1-B" class="g-slot" onclick="openModal('GL1-B')">GL1-B</div>
                    <div id="GR1-F" class="g-slot" onclick="openModal('GR1-F')">GR1-F</div> <div id="GR1-M" class="g-slot" onclick="openModal('GR1-M')">GR1-M</div> <div id="GR1-B" class="g-slot" onclick="openModal('GR1-B')">GR1-B</div>
                </div>
                <div id="GF2" class="col-start-2 row-start-5 slot-box writing-vertical text-[8px] h-full move-up" style="background-color: #64748b; border-color: #475569;" onclick="openModal('GF2')">GF2</div>
                <div class="col-start-3 row-start-5 g-container move-up">
                    <div id="GL2-F" class="g-slot" onclick="openModal('GL2-F')">GL2-F</div> <div id="GL2-M" class="g-slot" onclick="openModal('GL2-M')">GL2-M</div> <div id="GL2-B" class="g-slot" onclick="openModal('GL2-B')">GL2-B</div>
                    <div id="GR2-F" class="g-slot" onclick="openModal('GR2-F')">GR2-F</div> <div id="GR2-M" class="g-slot" onclick="openModal('GR2-M')">GR2-M</div> <div id="GR2-B" class="g-slot" onclick="openModal('GR2-B')">GR2-B</div>
                </div>
                <div id="CASHIER" class="col-start-3 row-start-7 row-span-2 cashier-box h-full" style="align-self: stretch;">CASHIER</div>

                <div class="col-start-5 row-start-3 g-container">
                    <div id="GL3-F" class="g-slot" onclick="openModal('GL3-F')">GL3-F</div> <div id="GL3-M" class="g-slot" onclick="openModal('GL3-M')">GL3-M</div> <div id="GL3-B" class="g-slot" onclick="openModal('GL3-B')">GL3-B</div>
                    <div id="GR3-F" class="g-slot" onclick="openModal('GR3-F')">GR3-F</div> <div id="GR3-M" class="g-slot" onclick="openModal('GR3-M')">GR3-M</div> <div id="GR3-B" class="g-slot" onclick="openModal('GR3-B')">GR3-B</div>
                </div>
                <div class="col-start-5 row-start-5 g-container">
                    <div id="GL4-F" class="g-slot" onclick="openModal('GL4-F')">GL4-F</div> <div id="GL4-M" class="g-slot" onclick="openModal('GL4-M')">GL4-M</div> <div id="GL4-B" class="g-slot" onclick="openModal('GL4-B')">GL4-B</div>
                    <div id="GR4-F" class="g-slot" onclick="openModal('GR4-F')">GR4-F</div> <div id="GR4-M" class="g-slot" onclick="openModal('GR4-M')">GR4-M</div> <div id="GR4-B" class="g-slot" onclick="openModal('GR4-B')">GR4-B</div>
                </div>
                <div class="col-start-5 row-start-7 g-container">
                    <div id="GL5-F" class="g-slot" onclick="openModal('GL5-F')">GL5-F</div> <div id="GL5-M" class="g-slot" onclick="openModal('GL5-M')">GL5-M</div> <div id="GL5-B" class="g-slot" onclick="openModal('GL5-B')">GL5-B</div>
                    <div id="GR5-F" class="g-slot" onclick="openModal('GR5-F')">GR5-F</div> <div id="GR5-M" class="g-slot" onclick="openModal('GR5-M')">GR5-M</div> <div id="GR5-B" class="g-slot" onclick="openModal('GR5-B')">GR5-B</div>
                </div>

                <div class="col-start-7 row-start-3 g-container">
                    <div id="GL6-F" class="g-slot" onclick="openModal('GL6-F')">GL6-F</div> <div id="GL6-M" class="g-slot" onclick="openModal('GL6-M')">GL6-M</div> <div id="GL6-B" class="g-slot" onclick="openModal('GL6-B')">GL6-B</div>
                    <div id="GR6-F" class="g-slot" onclick="openModal('GR6-F')">GR6-F</div> <div id="GR6-M" class="g-slot" onclick="openModal('GR6-M')">GR6-M</div> <div id="GR6-B" class="g-slot" onclick="openModal('GR6-B')">GR6-B</div>
                </div>
                <div class="col-start-7 row-start-5 g-container">
                    <div id="GL7-F" class="g-slot" onclick="openModal('GL7-F')">GL7-F</div> <div id="GL7-M" class="g-slot" onclick="openModal('GL7-M')">GL7-M</div> <div id="GL7-B" class="g-slot" onclick="openModal('GL7-B')">GL7-B</div>
                    <div id="GR7-F" class="g-slot" onclick="openModal('GR7-F')">GR7-F</div> <div id="GR7-M" class="g-slot" onclick="openModal('GR7-M')">GR7-M</div> <div id="GR7-B" class="g-slot" onclick="openModal('GR7-B')">GR7-B</div>
                </div>
                <div class="col-start-7 row-start-7 g-container">
                    <div id="GL8-F" class="g-slot" onclick="openModal('GL8-F')">GL8-F</div> <div id="GL8-M" class="g-slot" onclick="openModal('GL8-M')">GL8-M</div> <div id="GL8-B" class="g-slot" onclick="openModal('GL8-B')">GL8-B</div>
                    <div id="GR8-F" class="g-slot" onclick="openModal('GR8-F')">GR8-F</div> <div id="GR8-M" class="g-slot" onclick="openModal('GR8-M')">GR8-M</div> <div id="GR8-B" class="g-slot" onclick="openModal('GR8-B')">GR8-B</div>
                </div>

                <div class="col-start-9 row-start-7 g-container">
                    <div id="GL9-F" class="g-slot" onclick="openModal('GL9-F')">GL9-F</div> <div id="GL9-M" class="g-slot" onclick="openModal('GL9-M')">GL9-M</div> <div id="GL9-B" class="g-slot" onclick="openModal('GL9-B')">GL9-B</div>
                    <div id="GR9-F" class="g-slot" onclick="openModal('GR9-F')">GR9-F</div> <div id="GR9-M" class="g-slot" onclick="openModal('GR9-M')">GR9-M</div> <div id="GR9-B" class="g-slot" onclick="openModal('GR9-B')">GR9-B</div>
                </div>

                <div class="col-start-2 col-span-2 row-start-9 h-8 self-end px-2 z-10 mb-1">
                    <div id="CS" class="slot-box w-full h-full" onclick="openModal('CS')">CS</div>
                </div>
                
                <div class="col-start-4 col-span-4 row-start-9 flex gap-1 h-8 self-end z-10 mb-1 justify-start">
                    <div id="WR1" class="slot-box flex-1" onclick="openModal('WR1')">WR1</div>
                    <div id="WR2" class="slot-box flex-1" onclick="openModal('WR2')">WR2</div>
                    <div id="WR3" class="slot-box flex-1" onclick="openModal('WR3')">WR3</div>
                    <div id="WR4" class="slot-box flex-1" onclick="openModal('WR4')">WR4</div>
                    <div id="WR5" class="slot-box flex-1" onclick="openModal('WR5')">WR5</div>
                </div>

                <div class="col-start-2 col-span-2 row-start-10 flex gap-2 h-8 mt-1">
                    <div id="BBL" class="slot-box outside-box flex-1" onclick="openModal('BBL')">BBL</div>
                    <div id="BBR" class="slot-box outside-box flex-1" onclick="openModal('BBR')">BBR</div>
                </div>
            </div>
        </div>
    </main>

    <div id="slotModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl overflow-hidden flex flex-col md:flex-row max-h-[80vh]">
            <div class="w-full md:w-1/2 bg-gray-100 relative group flex items-center justify-center bg-black">
                <img id="modalImg" src="" class="w-full h-full object-contain max-h-[400px]" onerror="this.src='https://placehold.co/600x400?text=No+Photo'">
                <div id="modalCarouselControls" class="hidden">
                    <div class="carousel-btn carousel-prev" onclick="prevModalSlide()"><i class="fa-solid fa-chevron-left"></i></div>
                    <div class="carousel-btn carousel-next" onclick="nextModalSlide()"><i class="fa-solid fa-chevron-right"></i></div>
                    <div class="carousel-dots" id="modalDots"></div>
                </div>
                <div class="absolute bottom-4 left-4 bg-black/60 text-white text-xs px-2 py-1 rounded" id="modalImgCounter">1/1</div>
            </div>
            <div class="w-full md:w-1/2 flex flex-col">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800" id="modalTitle">SLOT NAME</h2>
                        <p class="text-xs text-gray-500">Sales Availability Status</p>
                    </div>
                    <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center transition"><i class="fa-solid fa-xmark text-gray-600"></i></button>
                </div>
                <div class="p-4 overflow-y-auto flex-1 space-y-2 bg-white" id="layerList"></div>
            </div>
        </div>
    </div>

    <script>
        const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRPt5_VqUQSurUF8zod1Ns67QBSMvPhFwpuwvniE8wzX3dDOrXyxClrDywMwMnkaJ-Ite1M3DlLeTZt/pub?output=csv";
        const REPORT_URL = "index.html"; 

        let salesData = {};
        let modalImages = [];
        let currentModalImgIdx = 0;

        Papa.parse(SHEET_CSV_URL, {
            download: true, header: true, skipEmptyLines: true,
            complete: function(results) { processSalesData(results.data); }
        });

        function convertDriveLink(url) {
            if (!url) return "";
            url = url.trim();
            if (url.includes("drive.google.com") && url.includes("/d/")) {
                const idMatch = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
                if (idMatch && idMatch[1]) return `https://drive.google.com/uc?export=view&id=${idMatch[1]}`;
            }
            return url;
        }

        function processSalesData(rows) {
            salesData = {};
            rows.forEach(row => {
                if (!row.Slot_ID) return;
                const lastDash = row.Slot_ID.lastIndexOf('-');
                if (lastDash === -1) return; 

                const slotCode = row.Slot_ID.substring(0, lastDash).trim();
                const layerCode = row.Slot_ID.substring(lastDash + 1).trim();

                if (!salesData[slotCode]) {
                    salesData[slotCode] = { images: [], layers: {} };
                    if (row.Shelf_Photo_URL) salesData[slotCode].images.push(convertDriveLink(row.Shelf_Photo_URL));
                    if (row.Shelf_Photo_URL_2) salesData[slotCode].images.push(convertDriveLink(row.Shelf_Photo_URL_2));
                }

                salesData[slotCode].layers[layerCode] = {
                    brandName: row.Brand_Name || row.Brand_ID,
                    brandId: row.Brand_ID,
                    logo: convertDriveLink(row.Brand_Logo_URL),
                    occupied: true
                };
            });
        }

        function openModal(slotID) {
            const modal = document.getElementById('slotModal');
            const title = document.getElementById('modalTitle');
            const list = document.getElementById('layerList');
            const ctrls = document.getElementById('modalCarouselControls');
            const dots = document.getElementById('modalDots');
            
            title.innerText = slotID;
            list.innerHTML = '';
            
            const data = salesData[slotID] || { images: [], layers: {} };
            modalImages = data.images.length > 0 ? data.images : ["https://placehold.co/600x400?text=No+Photo"];
            currentModalImgIdx = 0;
            updateModalImage();

            // Toggle Carousel UI
            if (modalImages.length > 1) {
                ctrls.classList.remove('hidden');
                dots.innerHTML = '';
                modalImages.forEach((_, idx) => {
                    const dot = document.createElement('div');
                    dot.className = `dot ${idx === 0 ? 'active' : ''}`;
                    dots.appendChild(dot);
                });
            } else {
                ctrls.classList.add('hidden');
            }

            for (let i = 1; i <= 6; i++) {
                const layerKey = `L${i}`;
                const layerInfo = data.layers[layerKey];
                const div = document.createElement('div');
                div.className = "flex items-center justify-between p-3 rounded-xl border border-gray-100 hover:bg-gray-50 transition";
                
                if (layerInfo) {
                    const logoHtml = layerInfo.logo 
                        ? `<img src="${layerInfo.logo}" class="w-10 h-10 object-contain rounded border bg-white">`
                        : `<div class="w-10 h-10 bg-gray-200 rounded flex items-center justify-center font-bold text-gray-500">${layerInfo.brandName.charAt(0)}</div>`;
                    
                    const reportLink = `./?brand=${layerInfo.brandId}`;

                    div.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-sm shadow-sm">${layerKey}</div>
                            ${logoHtml}
                            <div>
                                <div class="font-bold text-gray-800 text-sm">${layerInfo.brandName}</div>
                                <div class="text-[10px] text-red-500 font-bold uppercase tracking-wider flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-red-500"></span> Occupied</div>
                            </div>
                        </div>
                        <a href="${reportLink}" target="_blank" class="px-3 py-1.5 bg-white border border-gray-200 text-gray-600 rounded-lg text-xs font-bold hover:text-indigo-600 hover:border-indigo-600 transition shadow-sm">View</a>
                    `;
                } else {
                    div.innerHTML = `
                        <div class="flex items-center gap-4 opacity-60">
                            <div class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center font-bold text-sm">${layerKey}</div>
                            <div class="w-10 h-10 border-2 border-dashed border-gray-300 rounded flex items-center justify-center text-gray-300"><i class="fa-solid fa-plus"></i></div>
                            <div>
                                <div class="font-bold text-gray-400 text-sm">Empty Slot</div>
                                <div class="text-[10px] text-emerald-500 font-bold uppercase tracking-wider">Available</div>
                            </div>
                        </div>
                        <span class="px-3 py-1.5 bg-gray-50 text-gray-300 rounded-lg text-xs font-bold cursor-default border border-transparent">Empty</span>
                    `;
                }
                list.appendChild(div);
            }
            modal.classList.remove('hidden');
        }

        function closeModal() { document.getElementById('slotModal').classList.add('hidden'); }
        function updateModalImage() {
            const imgEl = document.getElementById('modalImg');
            document.getElementById('modalImgCounter').innerText = `${currentModalImgIdx + 1}/${modalImages.length}`;
            imgEl.src = modalImages[currentModalImgIdx];
            // Update dots
            const dots = document.querySelectorAll('.dot');
            dots.forEach((d, i) => {
                if(i === currentModalImgIdx) d.classList.add('active');
                else d.classList.remove('active');
            });
        }
        function nextModalSlide() { currentModalImgIdx = (currentModalImgIdx + 1) % modalImages.length; updateModalImage(); }
        function prevModalSlide() { currentModalImgIdx = (currentModalImgIdx - 1 + modalImages.length) % modalImages.length; updateModalImage(); }
        
        document.getElementById('slotModal').addEventListener('click', (e) => { if (e.target.id === 'slotModal') closeModal(); });

    </script>
</body>
</html>